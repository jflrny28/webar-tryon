<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Web AR Shoe Try-On</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- AR.js for A-Frame (marker-based AR) -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar-nft.js"></script>

  <style>
    html, body { margin:0; height:100%; background:#000; font-family: system-ui, sans-serif; }
    #hud {
      position: fixed; left: 0; right: 0; bottom: 0; padding: 12px 14px;
      color: #fff; background: linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0));
      text-align: center; font-size: 14px; pointer-events: none;
    }
    #topbar {
      position: fixed; top: 10px; left: 10px; right: 10px;
      display: flex; justify-content: space-between; gap: 8px; pointer-events: none;
    }
    .btn {
      pointer-events: auto; padding: 8px 12px; border-radius: 10px;
      background: rgba(0,0,0,.5); color:#fff; border: 1px solid rgba(255,255,255,.25);
      font: 14px/1.2 system-ui;
    }
    #toast {
      position: fixed; left: 50%; transform: translateX(-50%);
      top: 16px; background: rgba(0,0,0,.7); color:#fff; border-radius: 10px;
      padding: 8px 12px; font-size: 14px; display:none;
    }
    #loader {
      position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
      color: #fff; background: rgba(0,0,0,.6); padding: 8px 12px; border-radius: 8px;
      font-size: 14px; display:none;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>
<div id="topbar">
  <button class="btn" onclick="location.href='about:blank'">Close</button>
  <button class="btn" onclick="resetModel()">Reset</button>
</div>
<div id="toast"></div>
<div id="loader">Loading model…</div>
<div id="hud">
  Point your camera at the printed marker. Use two fingers to pinch (scale) and twist (rotate).
</div>

<!-- SCENE -->
<a-scene
  embedded
  renderer="antialias: true; physicallyCorrectLights: true; colorManagement: true"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false"
  arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

  <!-- Camera -->
  <a-entity camera></a-entity>

  <!-- Marker anchor: replace URL if you use your own marker -->
  <a-marker type="pattern" url="assets/marker.patt" id="marker">
    <!-- Lights -->
    <a-entity light="type: ambient; intensity: 0.6"></a-entity>
    <a-entity light="type: directional; intensity: 1" position="0 2 1"></a-entity>

    <!-- Your GLB goes here -->
    <a-entity id="shoe"
      position="0 0 0"
      rotation="-90 0 0"
      scale="1 1 1">
    </a-entity>

    <!-- Optional ground for visual reference -->
    <a-entity geometry="primitive: circle; radius: 0.6" rotation="-90 0 0"
              material="color: #000; opacity: 0.08"></a-entity>
  </a-marker>

  <!-- Keep scene alive even if marker isn’t visible -->
  <a-entity arjs-anchor></a-entity>
</a-scene>

<script>
  // --------- Helpers ---------
  const $ = sel => document.querySelector(sel);
  const toast = (msg, ms=1800) => {
    const t = $('#toast'); t.textContent = msg; t.style.display = 'block';
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> t.style.display = 'none', ms);
  };

  // --------- Load model URL from ?model=... or fallback ---------
  const params = new URLSearchParams(location.search);
  const modelURL = params.get('model') ||
    'https://firebasestorage.googleapis.com/v0/b/trial-50e43.firebasestorage.app/o/models%2Fshoe_1757851728914.glb?alt=media&token=f384d0bb-91c2-4d07-ac36-354e51db46f1';

  const shoe = document.getElementById('shoe');
  const loader = document.getElementById('loader');

  // Set GLB once A-Frame entity is ready
  shoe.addEventListener('model-error', e => {
    console.error(e);
    toast('Failed to load model.');
    loader.classList.add('hidden');
  });

  // Dynamically assign glTF src
  shoe.setAttribute('gltf-model', `url(${modelURL})`);

  // Show loader until the mesh is ready
  loader.style.display = 'block';
  shoe.addEventListener('model-loaded', () => {
    loader.classList.add('hidden');
    toast('Model loaded. Aim at the marker.');
  });

  // --------- Two-finger gestures (pinch scale + twist rotate) ---------
  let start = null;
  let baseScale = 1;
  let baseRotY = 0;

  const getTouches = e => [...e.touches].map(t => ({x:t.clientX, y:t.clientY}));
  const dist = (a,b) => Math.hypot(b.x-a.x, b.y-a.y);
  const ang  = (a,b) => Math.atan2(b.y-a.y, b.x-a.x);

  function onTouchStart(e){
    if(e.touches.length === 2){
      e.preventDefault();
      const [p1, p2] = getTouches(e);
      start = {
        d: dist(p1,p2),
        a: ang(p1,p2),
        scale: shoe.object3D.scale.x,
        rotY: shoe.object3D.rotation.y
      };
    }
  }

  function onTouchMove(e){
    if(e.touches.length === 2 && start){
      e.preventDefault();
      const [p1, p2] = getTouches(e);
      const d = dist(p1,p2);
      const a = ang(p1,p2);

      // scale
      const s = Math.max(0.2, Math.min(3, start.scale * (d / start.d)));
      shoe.object3D.scale.set(s, s, s);

      // rotate (around Y)
      shoe.object3D.rotation.y = start.rotY + (a - start.a);
    }
  }

  function onTouchEnd(e){
    if(e.touches.length < 2) start = null;
  }

  // Attach to canvas once available
  const scene = document.querySelector('a-scene');
  scene.addEventListener('loaded', () => {
    const canvas = scene.canvas;
    canvas.addEventListener('touchstart', onTouchStart, {passive:false});
    canvas.addEventListener('touchmove',  onTouchMove,  {passive:false});
    canvas.addEventListener('touchend',   onTouchEnd,   {passive:false});
  });

  // --------- Reset button ---------
  window.resetModel = () => {
    shoe.object3D.scale.set(1,1,1);
    shoe.object3D.rotation.set(-Math.PI/2, 0, 0);
    toast('Model reset.');
  };
</script>
</body>
</html>
